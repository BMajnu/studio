import{i as u,r as l,A as p}from"./chunks/auth-oyTCJP_F.js";let c=null,i=0;async function m(){return await new Promise(e=>{var t;try{(t=chrome.storage)==null||t.local.get(["DESAINR_BASE_URL"],r=>{e(r&&r.DESAINR_BASE_URL||null)})}catch{e(null)}})}async function f(e){var t;try{await((t=chrome.storage)==null?void 0:t.local.set({DESAINR_BASE_URL:e}))}catch{}}async function y(e){try{const t=await fetch(`${e}/api/extension/rewrite`,{method:"OPTIONS",headers:{"Content-Type":"application/json"}});return t.ok||t.status===204}catch{return!1}}async function w(){const e=Date.now();if(c&&e-i<6e4)return c;const t=[],r=await m();r&&t.push(r),t.push(p);const s=[...t,"http://localhost:9010","http://127.0.0.1:9010","https://localhost:9010","https://127.0.0.1:9010","http://localhost:9003","http://127.0.0.1:9003","https://localhost:9003","https://127.0.0.1:9003","http://localhost:3000","http://127.0.0.1:3000","https://localhost:3000","https://127.0.0.1:3000","http://localhost:5173","http://127.0.0.1:5173","https://localhost:5173","https://127.0.0.1:5173","http://localhost:8080","http://127.0.0.1:8080","https://localhost:8080","https://127.0.0.1:8080"],a=new Set;for(const n of s)if(!(!n||a.has(n))&&(a.add(n),await y(n)))return c=n,i=e,await f(n),n;return c=t[0]||"http://localhost:9010",i=e,c}async function A(e){try{return await chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}),!0}catch(t){return console.warn("[DesAInR] Failed to inject contentScript.js:",t),!1}}async function d(e,t){return await new Promise(a=>{try{chrome.tabs.sendMessage(e,t,()=>{var o;if((o=chrome.runtime.lastError)==null?void 0:o.message)return a(!1);a(!0)})}catch{a(!1)}})?!0:await A(e)?await new Promise(a=>{try{chrome.tabs.sendMessage(e,t,()=>{var o;const n=(o=chrome.runtime.lastError)==null?void 0:o.message;a(!n)})}catch{a(!1)}}):!1}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"desainr-refine",title:"DesAInR: Refine Selection",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-translate",title:"DesAInR: Translate Selection",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-save-memo",title:"DesAInR: Save to Memo",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-analyze",title:"DesAInR: Analyze Page",contexts:["page"]}),chrome.contextMenus.create({id:"desainr-translate-page",title:"DesAInR: Translate Page",contexts:["page"]}),chrome.contextMenus.create({id:"desainr-toggle-parallel",title:"DesAInR: Toggle Parallel Translate",contexts:["page"]}),chrome.alarms.create("desainr_refresh_token",{periodInMinutes:45})});u();setTimeout(()=>{l(!0).catch(()=>{})},5e3);chrome.runtime.onStartup.addListener(()=>{chrome.alarms.create("desainr_refresh_token",{periodInMinutes:45}),l(!0).catch(()=>{})});chrome.alarms.onAlarm.addListener(e=>{e.name==="desainr_refresh_token"&&l(!0).catch(()=>{})});chrome.contextMenus.onClicked.addListener((e,t)=>{t!=null&&t.id&&d(t.id,{type:"CONTEXT_MENU",id:e.menuItemId,info:e}).then(r=>{r||console.warn("[DesAInR] Could not deliver CONTEXT_MENU message (no receiver).")})});chrome.commands.onCommand.addListener(e=>{e==="toggle-overlay"&&chrome.tabs.query({active:!0,currentWindow:!0},t=>{const r=t[0];r!=null&&r.id&&d(r.id,{type:"TOGGLE_OVERLAY"}).then(s=>{s||console.warn("[DesAInR] Could not deliver TOGGLE_OVERLAY message (no receiver).")})})});chrome.runtime.onMessage.addListener((e,t,r)=>{if((e==null?void 0:e.type)==="API_CALL")return(async()=>{try{const a=`${await w()}/api/extension/${e.path}`,n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.token}`},body:JSON.stringify(e.body??{})});let o,h;try{o=await n.json()}catch{try{h=await n.text()}catch{}}if(!n.ok&&(!o||typeof o!="object")){r({ok:!1,status:n.status,error:h||"HTTP error"});return}r({ok:n.ok,status:n.status,json:o??{}})}catch(s){r({ok:!1,status:0,error:(s==null?void 0:s.message)||String(s)})}})(),!0});
