import{i as u,r as h,A as f}from"./chunks/auth-Ce4RuJAx.js";let i=null,l=0;async function p(){return await new Promise(e=>{var t;try{(t=chrome.storage)==null||t.local.get(["DESAINR_BASE_URL"],n=>{e(n&&n.DESAINR_BASE_URL||null)})}catch{e(null)}})}async function m(e){var t;try{await((t=chrome.storage)==null?void 0:t.local.set({DESAINR_BASE_URL:e}))}catch{}}async function y(e){try{const t=await fetch(`${e}/api/extension/rewrite`,{method:"OPTIONS",headers:{"Content-Type":"application/json"}});return t.ok||t.status===204}catch{return!1}}async function A(){const e=Date.now();if(i&&e-l<6e4)return i;const t=[],n=await p();n&&t.push(n),t.push(f);const s=[...t,"http://localhost:9010","http://127.0.0.1:9010","https://localhost:9010","https://127.0.0.1:9010","http://localhost:9003","http://127.0.0.1:9003","https://localhost:9003","https://127.0.0.1:9003","http://localhost:3000","http://127.0.0.1:3000","https://localhost:3000","https://127.0.0.1:3000","http://localhost:5173","http://127.0.0.1:5173","https://localhost:5173","https://127.0.0.1:5173","http://localhost:8080","http://127.0.0.1:8080","https://localhost:8080","https://127.0.0.1:8080"],a=new Set;for(const r of s)if(!(!r||a.has(r))&&(a.add(r),await y(r)))return i=r,l=e,await m(r),r;return i=t[0]||"http://localhost:9010",l=e,i}async function S(e){try{return await chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}),!0}catch(t){return console.warn("[DesAInR] Failed to inject contentScript.js:",t),!1}}async function d(e,t){return await new Promise(a=>{try{chrome.tabs.sendMessage(e,t,()=>{var o;if((o=chrome.runtime.lastError)==null?void 0:o.message)return a(!1);a(!0)})}catch{a(!1)}})?!0:await S(e)?await new Promise(a=>{try{chrome.tabs.sendMessage(e,t,()=>{var o;const r=(o=chrome.runtime.lastError)==null?void 0:o.message;a(!r)})}catch{a(!1)}}):!1}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"desainr-refine",title:"DesAInR: Refine Selection",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-translate",title:"DesAInR: Translate Selection",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-save-memo",title:"DesAInR: Save to Memo",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-analyze",title:"DesAInR: Analyze Page",contexts:["page"]}),chrome.contextMenus.create({id:"desainr-translate-page",title:"DesAInR: Translate Page",contexts:["page"]}),chrome.contextMenus.create({id:"desainr-toggle-parallel",title:"DesAInR: Toggle Parallel Translate",contexts:["page"]}),chrome.alarms.create("desainr_refresh_token",{periodInMinutes:45})});u();setTimeout(()=>{h(!0).catch(()=>{})},5e3);chrome.runtime.onStartup.addListener(()=>{chrome.alarms.create("desainr_refresh_token",{periodInMinutes:45}),h(!0).catch(()=>{})});chrome.alarms.onAlarm.addListener(e=>{e.name==="desainr_refresh_token"&&h(!0).catch(()=>{})});chrome.contextMenus.onClicked.addListener((e,t)=>{t!=null&&t.id&&d(t.id,{type:"CONTEXT_MENU",id:e.menuItemId,info:e}).then(n=>{n||console.warn("[DesAInR] Could not deliver CONTEXT_MENU message (no receiver).")})});chrome.commands.onCommand.addListener(e=>{e==="toggle-overlay"&&chrome.tabs.query({active:!0,currentWindow:!0},t=>{const n=t[0];n!=null&&n.id&&d(n.id,{type:"TOGGLE_OVERLAY"}).then(s=>{s||console.warn("[DesAInR] Could not deliver TOGGLE_OVERLAY message (no receiver).")})})});chrome.runtime.onMessage.addListener((e,t,n)=>{if((e==null?void 0:e.type)==="API_CALL")return(async()=>{try{const a=`${await A()}/api/extension/${e.path}`,r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.token}`},body:JSON.stringify(e.body??{})});let o,c;try{o=await r.json()}catch{try{c=await r.text()}catch{}}if(!r.ok&&(!o||typeof o!="object")){n({ok:!1,status:r.status,error:c||"HTTP error"});return}n({ok:r.ok,status:r.status,json:o??{}})}catch(s){n({ok:!1,status:0,error:(s==null?void 0:s.message)||String(s)})}})(),!0;if((e==null?void 0:e.type)==="SAVE_PINNED_ACTIONS")return(async()=>{var s,a;try{const r=Array.isArray(e.actions)?e.actions:[];await((a=(s=chrome.storage)==null?void 0:s.sync)==null?void 0:a.set({"desainr.pinnedActions":r}));try{chrome.tabs.query({},o=>{for(const c of o)c!=null&&c.id&&d(c.id,{type:"SAVE_PINNED_ACTIONS",actions:r}).catch(()=>{})})}catch{}n({ok:!0})}catch(r){n({ok:!1,status:0,error:(r==null?void 0:r.message)||String(r)})}})(),!0});
