import{A as S}from"./chunks/config-Y9mzPb9C.js";let h=null,f=0;async function k(){return await new Promise(e=>{var t;try{(t=chrome.storage)==null||t.local.get(["DESAINR_BASE_URL"],r=>{e(r&&r.DESAINR_BASE_URL||null)})}catch{e(null)}})}async function E(e){var t;try{await((t=chrome.storage)==null?void 0:t.local.set({DESAINR_BASE_URL:e}))}catch{}}async function I(e){try{const t=await fetch(`${e}/api/extension/rewrite`,{method:"OPTIONS",headers:{"Content-Type":"application/json"}});return t.ok||t.status===204}catch{return!1}}async function m(){const e=Date.now();if(h&&e-f<6e4)return h;const t=[],r=await k();r&&t.push(r);const n=["http://localhost:9010","http://127.0.0.1:9010","https://localhost:9010","https://127.0.0.1:9010","http://localhost:9003","http://127.0.0.1:9003","https://localhost:9003","https://127.0.0.1:9003","http://localhost:3000","http://127.0.0.1:3000","https://localhost:3000","https://127.0.0.1:3000","http://localhost:5173","http://127.0.0.1:5173","https://localhost:5173","https://127.0.0.1:5173","http://localhost:8080","http://127.0.0.1:8080","https://localhost:8080","https://127.0.0.1:8080"],a=[...t,...n,S],c=new Set;for(const o of a)if(!(!o||c.has(o))&&(c.add(o),await I(o)))return h=o,f=e,await E(o),o;return h=t[0]||"http://localhost:9010",f=e,h}async function p(){return await new Promise(e=>{var t;try{(t=chrome.storage)==null||t.local.get(["DESAINR_ID_TOKEN"],r=>{e(r&&r.DESAINR_ID_TOKEN||null)})}catch{e(null)}})}async function w(e){var t;try{await((t=chrome.storage)==null?void 0:t.local.set({DESAINR_ID_TOKEN:e}))}catch{}}async function g(){var e;try{await((e=chrome.storage)==null?void 0:e.local.remove(["DESAINR_ID_TOKEN"]))}catch{}}function T(e){try{const t=e.split(".");if(t.length!==3)return null;const r=t[1].replace(/-/g,"+").replace(/_/g,"/"),n=r.padEnd(r.length+(4-r.length%4)%4,"="),a=atob(n);return JSON.parse(a)}catch{return null}}async function x(e){return await new Promise(t=>{try{const r=e.endsWith("/")?`${e}*`:`${e}/*`;chrome.tabs.query({url:r},n=>{t(n&&n[0]?n[0]:null)})}catch{t(null)}})}async function _(e){return await new Promise(t=>{const r=(n,a)=>{n===e&&a.status==="complete"&&(chrome.tabs.onUpdated.removeListener(r),t())};chrome.tabs.onUpdated.addListener(r)})}async function D(e){const t=await m(),r=await x(t);return r&&r.id?r:(e==null?void 0:e.openIfMissing)===!1?null:await new Promise(n=>{chrome.tabs.create({url:`${t}/`},async a=>{a!=null&&a.id&&await _(a.id),n(a)})})}async function y(e=8e3,t){const r=await D({openIfMissing:(t==null?void 0:t.openIfMissing)!==!1});if(!(r!=null&&r.id))return{ok:!1,error:"no_webapp_tab"};const n=()=>new Promise(async c=>{let o=!1;const s=i=>{o||(o=!0,c(i))};try{chrome.tabs.sendMessage(r.id,{type:"DESAINR_GET_WEBAPP_ID_TOKEN"},async i=>{var d;if((d=chrome.runtime.lastError)==null?void 0:d.message)return s(null);s(i||{ok:!1,error:"no_response"})})}catch{s(null)}setTimeout(()=>s({ok:!1,error:"timeout"}),e)});let a=await n();if(!a){try{await chrome.scripting.executeScript({target:{tabId:r.id},files:["contentScript.js"]})}catch{}a=await n()}if(a&&!a.ok&&a.error==="not_signed_in"&&(t!=null&&t.promptLoginIfUnauthorized))try{const c=await m();await new Promise(o=>{chrome.tabs.update(r.id,{url:`${c}/login?next=/`},()=>o())}),await _(r.id)}catch{}return a||{ok:!1,error:"no_receiver"}}async function N(e){try{return await chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}),!0}catch(t){return console.warn("[DesAInR] Failed to inject contentScript.js:",t),!1}}async function A(e,t){return await new Promise(a=>{try{chrome.tabs.sendMessage(e,t,()=>{var o;if((o=chrome.runtime.lastError)==null?void 0:o.message)return a(!1);a(!0)})}catch{a(!1)}})?!0:await N(e)?await new Promise(a=>{try{chrome.tabs.sendMessage(e,t,()=>{var o;const c=(o=chrome.runtime.lastError)==null?void 0:o.message;a(!c)})}catch{a(!1)}}):!1}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"desainr-refine",title:"DesAInR: Refine Selection",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-translate",title:"DesAInR: Translate Selection",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-save-memo",title:"DesAInR: Save to Memo",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-analyze",title:"DesAInR: Analyze Page",contexts:["page"]}),chrome.contextMenus.create({id:"desainr-translate-page",title:"DesAInR: Translate Page",contexts:["page"]}),chrome.contextMenus.create({id:"desainr-toggle-parallel",title:"DesAInR: Toggle Parallel Translate",contexts:["page"]})});chrome.contextMenus.onClicked.addListener((e,t)=>{t!=null&&t.id&&A(t.id,{type:"CONTEXT_MENU",id:e.menuItemId,info:e}).then(r=>{r||console.warn("[DesAInR] Could not deliver CONTEXT_MENU message (no receiver).")})});chrome.commands.onCommand.addListener(e=>{e==="toggle-overlay"&&chrome.tabs.query({active:!0,currentWindow:!0},t=>{const r=t[0];r!=null&&r.id&&A(r.id,{type:"TOGGLE_OVERLAY"}).then(n=>{n||console.warn("[DesAInR] Could not deliver TOGGLE_OVERLAY message (no receiver).")})})});chrome.runtime.onMessage.addListener((e,t,r)=>{if((e==null?void 0:e.type)==="AUTH_REQUEST_TOKEN")return(async()=>{try{const n=await y(8e3,{openIfMissing:!0,promptLoginIfUnauthorized:!0});n!=null&&n.ok&&n.idToken?(await w(n.idToken),r({ok:!0})):r({ok:!1,error:(n==null?void 0:n.error)||"failed"})}catch(n){r({ok:!1,error:(n==null?void 0:n.message)||String(n)})}})(),!0;if((e==null?void 0:e.type)==="AUTH_HAS_TOKEN")return(async()=>{const n=await p();r({hasToken:!!n})})(),!0;if((e==null?void 0:e.type)==="AUTH_CLEAR_TOKEN")return(async()=>(await g(),r({ok:!0})))(),!0;if((e==null?void 0:e.type)==="AUTH_GET_PROFILE")return(async()=>{try{const n=await p();if(!n){r({ok:!1,error:"no_token"});return}let a=T(n)||{};const c=Math.floor(Date.now()/1e3);let o=typeof a.exp=="number"?a.exp<c:!1;if(o)try{const i=await y(8e3,{openIfMissing:!0,promptLoginIfUnauthorized:!0});i!=null&&i.ok&&i.idToken&&(await w(i.idToken),a=T(i.idToken)||{},o=typeof a.exp=="number"?a.exp<c:!1)}catch{}const s={email:a.email||null,name:a.name||a.displayName||null,picture:a.picture||null,provider:a.firebase&&a.firebase.sign_in_provider||null,uid:a.user_id||a.sub||null,exp:a.exp||null,expired:o,iss:a.iss||null,aud:a.aud||null};r({ok:!0,profile:s})}catch(n){r({ok:!1,error:(n==null?void 0:n.message)||String(n)})}})(),!0;if((e==null?void 0:e.type)==="API_CALL")return(async()=>{try{const a=`${await m()}/api/extension/${e.path}`,c={"Content-Type":"application/json"},o=await p();e.token?c.Authorization=`Bearer ${e.token}`:o&&(c.Authorization=`Bearer ${o}`);const s=async()=>await fetch(a,{method:"POST",headers:c,body:JSON.stringify(e.body??{})});let i=await s();if(i.status===401){const l=await y(8e3,{openIfMissing:!0,promptLoginIfUnauthorized:!0});l!=null&&l.ok&&l.idToken&&(await w(l.idToken),c.Authorization=`Bearer ${l.idToken}`,i=await s())}let u,d;try{u=await i.json()}catch{try{d=await i.text()}catch{}}if(!i.ok&&(!u||typeof u!="object")){r({ok:!1,status:i.status,error:d||"HTTP error"});return}r({ok:i.ok,status:i.status,json:u??{}})}catch(n){r({ok:!1,status:0,error:(n==null?void 0:n.message)||String(n)})}})(),!0});
