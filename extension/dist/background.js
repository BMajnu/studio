import{A as s}from"./chunks/config-CwCn-sz8.js";let d=null,y=0;async function _(){try{const e=await I();e&&/^(https?:\/\/)?(localhost|127\.0\.0\.1)/i.test(e)&&(await T(s),d=s,y=Date.now()),_()}catch{}}async function I(){return await new Promise(e=>{var n;try{(n=chrome.storage)==null||n.local.get(["DESAINR_BASE_URL"],t=>{e(t&&t.DESAINR_BASE_URL||null)})}catch{e(null)}})}async function T(e){var n;try{await((n=chrome.storage)==null?void 0:n.local.set({DESAINR_BASE_URL:e}))}catch{}}async function g(){const e=Date.now();if(d){if(/^(https?:\/\/)?(localhost|127\.0\.0\.1)/i.test(d))return d=s,y=e,await T(s),s;if(e-y<6e4)return d}return d=s,y=e,await T(s),s}async function w(){return await new Promise(e=>{var n;try{(n=chrome.storage)==null||n.local.get(["DESAINR_ID_TOKEN"],t=>{e(t&&t.DESAINR_ID_TOKEN||null)})}catch{e(null)}})}async function p(e){var n;try{await((n=chrome.storage)==null?void 0:n.local.set({DESAINR_ID_TOKEN:e}))}catch{}}async function x(){var e;try{await((e=chrome.storage)==null?void 0:e.local.remove(["DESAINR_ID_TOKEN"]))}catch{}}function A(e){try{const n=e.split(".");if(n.length!==3)return null;const t=n[1].replace(/-/g,"+").replace(/_/g,"/"),r=t.padEnd(t.length+(4-t.length%4)%4,"="),a=atob(r);return JSON.parse(a)}catch{return null}}async function D(e){return await new Promise(n=>{try{const t=e.endsWith("/")?`${e}*`:`${e}/*`;chrome.tabs.query({url:t},r=>{n(r&&r[0]?r[0]:null)})}catch{n(null)}})}async function k(e){return await new Promise(n=>{const t=(r,a)=>{r===e&&a.status==="complete"&&(chrome.tabs.onUpdated.removeListener(t),n())};chrome.tabs.onUpdated.addListener(t)})}async function L(e){const n=s,t=await D(n);return t&&t.id?t:(e==null?void 0:e.openIfMissing)===!1?null:await new Promise(r=>{chrome.tabs.create({url:`${n}/`},async a=>{a!=null&&a.id&&await k(a.id),r(a)})})}async function m(e=8e3,n){const t=await L({openIfMissing:(n==null?void 0:n.openIfMissing)!==!1});if(!(t!=null&&t.id))return{ok:!1,error:"no_webapp_tab"};const r=()=>new Promise(async c=>{let o=!1;const l=i=>{o||(o=!0,c(i))};try{chrome.tabs.sendMessage(t.id,{type:"DESAINR_GET_WEBAPP_ID_TOKEN"},async i=>{var h;if((h=chrome.runtime.lastError)==null?void 0:h.message)return l(null);l(i||{ok:!1,error:"no_response"})})}catch{l(null)}setTimeout(()=>l({ok:!1,error:"timeout"}),e)});let a=await r();if(!a){try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["contentScript.js"]})}catch{}a=await r()}if(a&&!a.ok&&a.error==="not_signed_in"&&(n!=null&&n.promptLoginIfUnauthorized))try{const c=s;await new Promise(o=>{chrome.tabs.update(t.id,{url:`${c}/login?next=/`},()=>o())}),await k(t.id)}catch{}return a||{ok:!1,error:"no_receiver"}}async function N(e){try{return await chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}),!0}catch(n){return console.warn("[DesAInR] Failed to inject contentScript.js:",n),!1}}async function S(e,n){return await new Promise(a=>{try{chrome.tabs.sendMessage(e,n,()=>{var o;if((o=chrome.runtime.lastError)==null?void 0:o.message)return a(!1);a(!0)})}catch{a(!1)}})?!0:await N(e)?await new Promise(a=>{try{chrome.tabs.sendMessage(e,n,()=>{var o;const c=(o=chrome.runtime.lastError)==null?void 0:o.message;a(!c)})}catch{a(!1)}}):!1}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"desainr-refine",title:"DesAInR: Refine Selection",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-translate",title:"DesAInR: Translate Selection",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-save-memo",title:"DesAInR: Save to Memo",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-analyze",title:"DesAInR: Analyze Page",contexts:["page"]}),chrome.contextMenus.create({id:"desainr-translate-page",title:"DesAInR: Translate Page",contexts:["page"]}),chrome.contextMenus.create({id:"desainr-toggle-parallel",title:"DesAInR: Toggle Parallel Translate",contexts:["page"]}),_()});var E;(E=chrome.runtime.onStartup)==null||E.addListener(()=>{_()});chrome.contextMenus.onClicked.addListener((e,n)=>{n!=null&&n.id&&S(n.id,{type:"CONTEXT_MENU",id:e.menuItemId,info:e}).then(t=>{t||console.warn("[DesAInR] Could not deliver CONTEXT_MENU message (no receiver).")})});chrome.commands.onCommand.addListener(e=>{e==="toggle-overlay"&&chrome.tabs.query({active:!0,currentWindow:!0},n=>{const t=n[0];t!=null&&t.id&&S(t.id,{type:"TOGGLE_OVERLAY"}).then(r=>{r||console.warn("[DesAInR] Could not deliver TOGGLE_OVERLAY message (no receiver).")})})});chrome.runtime.onMessage.addListener((e,n,t)=>{if((e==null?void 0:e.type)==="AUTH_REQUEST_TOKEN")return(async()=>{try{const r=await m(8e3,{openIfMissing:!0,promptLoginIfUnauthorized:!0});r!=null&&r.ok&&r.idToken?(await p(r.idToken),t({ok:!0})):t({ok:!1,error:(r==null?void 0:r.error)||"failed"})}catch(r){t({ok:!1,error:(r==null?void 0:r.message)||String(r)})}})(),!0;if((e==null?void 0:e.type)==="AUTH_HAS_TOKEN")return(async()=>{const r=await w();t({hasToken:!!r})})(),!0;if((e==null?void 0:e.type)==="AUTH_CLEAR_TOKEN")return(async()=>(await x(),t({ok:!0})))(),!0;if((e==null?void 0:e.type)==="AUTH_GET_PROFILE")return(async()=>{try{const r=await w();if(!r){t({ok:!1,error:"no_token"});return}let a=A(r)||{};const c=Math.floor(Date.now()/1e3);let o=typeof a.exp=="number"?a.exp<c:!1;if(o)try{const i=await m(8e3,{openIfMissing:!0,promptLoginIfUnauthorized:!0});i!=null&&i.ok&&i.idToken&&(await p(i.idToken),a=A(i.idToken)||{},o=typeof a.exp=="number"?a.exp<c:!1)}catch{}const l={email:a.email||null,name:a.name||a.displayName||null,picture:a.picture||null,provider:a.firebase&&a.firebase.sign_in_provider||null,uid:a.user_id||a.sub||null,exp:a.exp||null,expired:o,iss:a.iss||null,aud:a.aud||null};t({ok:!0,profile:l})}catch(r){t({ok:!1,error:(r==null?void 0:r.message)||String(r)})}})(),!0;if((e==null?void 0:e.type)==="API_CALL")return(async()=>{try{const a=`${await g()}/api/extension/${e.path}`,c={"Content-Type":"application/json"},o=await w();e.token?c.Authorization=`Bearer ${e.token}`:o&&(c.Authorization=`Bearer ${o}`);const l=async()=>await fetch(a,{method:"POST",headers:c,body:JSON.stringify(e.body??{})});let i=await l();if(i.status===401){const u=await m(8e3,{openIfMissing:!0,promptLoginIfUnauthorized:!0});u!=null&&u.ok&&u.idToken&&(await p(u.idToken),c.Authorization=`Bearer ${u.idToken}`,i=await l())}let f,h;try{f=await i.json()}catch{try{h=await i.text()}catch{}}if(!i.ok&&(!f||typeof f!="object")){t({ok:!1,status:i.status,error:h||"HTTP error"});return}t({ok:i.ok,status:i.status,json:f??{}})}catch(r){t({ok:!1,status:0,error:(r==null?void 0:r.message)||String(r)})}})(),!0});
