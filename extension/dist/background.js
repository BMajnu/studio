import{A as l}from"./chunks/config-CwCn-sz8.js";let h=null,A=0;async function I(){try{const e=await U();e&&/^(https?:\/\/)?(localhost|127\.0\.0\.1)/i.test(e)&&(await k(l),h=l,A=Date.now())}catch{}}I().catch(()=>{});async function U(){return await new Promise(e=>{var r;try{(r=chrome.storage)==null||r.local.get(["DESAINR_BASE_URL"],t=>{e(t&&t.DESAINR_BASE_URL||null)})}catch{e(null)}})}async function k(e){var r;try{await((r=chrome.storage)==null?void 0:r.local.set({DESAINR_BASE_URL:e}))}catch{}}async function M(){const e=Date.now();if(h){if(/^(https?:\/\/)?(localhost|127\.0\.0\.1)/i.test(h))return h=l,A=e,await k(l),l;if(e-A<6e4)return h}return h=l,A=e,await k(l),l}async function _(){return await new Promise(e=>{var r;try{(r=chrome.storage)==null||r.local.get(["DESAINR_ID_TOKEN"],t=>{e(t&&t.DESAINR_ID_TOKEN||null)})}catch{e(null)}})}async function p(e){var r;try{await((r=chrome.storage)==null?void 0:r.local.set({DESAINR_ID_TOKEN:e}))}catch{}}async function N(){var e;try{await((e=chrome.storage)==null?void 0:e.local.remove(["DESAINR_ID_TOKEN"]))}catch{}}function S(e){try{const r=e.split(".");if(r.length!==3)return null;const t=r[1].replace(/-/g,"+").replace(/_/g,"/"),a=t.padEnd(t.length+(4-t.length%4)%4,"="),n=atob(a);return JSON.parse(n)}catch{return null}}async function P(e){return await new Promise(r=>{try{const t=e.endsWith("/")?`${e}*`:`${e}/*`;chrome.tabs.query({url:t},a=>{r(a&&a[0]?a[0]:null)})}catch{r(null)}})}async function x(e){return await new Promise(r=>{const t=(a,n)=>{a===e&&n.status==="complete"&&(chrome.tabs.onUpdated.removeListener(t),r())};chrome.tabs.onUpdated.addListener(t)})}async function O(e){const r=l,t=await P(r);return t&&t.id?t:(e==null?void 0:e.openIfMissing)===!1?null:await new Promise(a=>{chrome.tabs.create({url:`${r}/`},async n=>{n!=null&&n.id&&await x(n.id),a(n)})})}async function m(e=8e3,r){const t=await O({openIfMissing:(r==null?void 0:r.openIfMissing)!==!1});if(!(t!=null&&t.id))return{ok:!1,error:"no_webapp_tab"};const a=()=>new Promise(async s=>{let i=!1;const d=c=>{i||(i=!0,s(c))};try{chrome.tabs.sendMessage(t.id,{type:"DESAINR_GET_WEBAPP_ID_TOKEN"},async c=>{var f;if((f=chrome.runtime.lastError)==null?void 0:f.message)return d(null);d(c||{ok:!1,error:"no_response"})})}catch{d(null)}setTimeout(()=>d({ok:!1,error:"timeout"}),e)});let n=await a();if(!n){try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["contentScript.js"]})}catch{}n=await a()}if(n&&!n.ok&&n.error==="not_signed_in"&&(r!=null&&r.promptLoginIfUnauthorized))try{const s=l;await new Promise(i=>{chrome.tabs.update(t.id,{url:`${s}/login?next=/`},()=>i())}),await x(t.id)}catch{}return n||{ok:!1,error:"no_receiver"}}async function R(e){try{return await chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}),!0}catch(r){return console.warn("[DesAInR] Failed to inject contentScript.js:",r),!1}}async function D(e,r){return await new Promise(n=>{try{chrome.tabs.sendMessage(e,r,()=>{var i;if((i=chrome.runtime.lastError)==null?void 0:i.message)return n(!1);n(!0)})}catch{n(!1)}})?!0:await R(e)?await new Promise(n=>{try{chrome.tabs.sendMessage(e,r,()=>{var i;const s=(i=chrome.runtime.lastError)==null?void 0:i.message;n(!s)})}catch{n(!1)}}):!1}chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"desainr-refine",title:"DesAInR: Refine Selection",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-translate",title:"DesAInR: Translate Selection",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-save-memo",title:"DesAInR: Save to Memo",contexts:["selection"]}),chrome.contextMenus.create({id:"desainr-analyze",title:"DesAInR: Analyze Page",contexts:["page"]}),chrome.contextMenus.create({id:"desainr-translate-page",title:"DesAInR: Translate Page",contexts:["page"]}),chrome.contextMenus.create({id:"desainr-toggle-parallel",title:"DesAInR: Toggle Parallel Translate",contexts:["page"]}),I()});var L;(L=chrome.runtime.onStartup)==null||L.addListener(()=>{I()});chrome.contextMenus.onClicked.addListener((e,r)=>{r!=null&&r.id&&D(r.id,{type:"CONTEXT_MENU",id:e.menuItemId,info:e}).then(t=>{t||console.warn("[DesAInR] Could not deliver CONTEXT_MENU message (no receiver).")})});chrome.commands.onCommand.addListener(e=>{e==="toggle-overlay"&&chrome.tabs.query({active:!0,currentWindow:!0},r=>{const t=r[0];t!=null&&t.id&&D(t.id,{type:"TOGGLE_OVERLAY"}).then(a=>{a||console.warn("[DesAInR] Could not deliver TOGGLE_OVERLAY message (no receiver).")})})});chrome.runtime.onMessage.addListener((e,r,t)=>{if((e==null?void 0:e.type)==="AUTH_REQUEST_TOKEN")return(async()=>{try{const a=await m(8e3,{openIfMissing:!0,promptLoginIfUnauthorized:!0});a!=null&&a.ok&&a.idToken?(await p(a.idToken),t({ok:!0})):t({ok:!1,error:(a==null?void 0:a.error)||"failed"})}catch(a){t({ok:!1,error:(a==null?void 0:a.message)||String(a)})}})(),!0;if((e==null?void 0:e.type)==="AUTH_HAS_TOKEN")return(async()=>{const a=await _();t({hasToken:!!a})})(),!0;if((e==null?void 0:e.type)==="AUTH_CLEAR_TOKEN")return(async()=>(await N(),t({ok:!0})))(),!0;if((e==null?void 0:e.type)==="AUTH_GET_PROFILE")return(async()=>{try{const a=await _();if(!a){t({ok:!1,error:"no_token"});return}let n=S(a)||{};const s=Math.floor(Date.now()/1e3);let i=typeof n.exp=="number"?n.exp<s:!1;if(i)try{const c=await m(8e3,{openIfMissing:!0,promptLoginIfUnauthorized:!0});c!=null&&c.ok&&c.idToken&&(await p(c.idToken),n=S(c.idToken)||{},i=typeof n.exp=="number"?n.exp<s:!1)}catch{}const d={email:n.email||null,name:n.name||n.displayName||null,picture:n.picture||null,provider:n.firebase&&n.firebase.sign_in_provider||null,uid:n.user_id||n.sub||null,exp:n.exp||null,expired:i,iss:n.iss||null,aud:n.aud||null};t({ok:!0,profile:d})}catch(a){t({ok:!1,error:(a==null?void 0:a.message)||String(a)})}})(),!0;if((e==null?void 0:e.type)==="API_CALL")return(async()=>{var a,n,s;try{const i=await M(),d=`${i}/api/extension/${e.path}`,c={"Content-Type":"application/json"};let y=await _();if(!e.token&&!y)try{const o=await m(8e3,{openIfMissing:!0,promptLoginIfUnauthorized:!0});o!=null&&o.ok&&o.idToken&&(await p(o.idToken),y=o.idToken)}catch{}e.token?c.Authorization=`Bearer ${e.token}`:y&&(c.Authorization=`Bearer ${y}`);let f=e.body??{};try{const o=await((s=(a=chrome.storage)==null?void 0:(n=a.local).get)==null?void 0:s.call(n,["desainr.settings.userApiKey"]).catch(()=>({}))),E=o==null?void 0:o["desainr.settings.userApiKey"];E&&!f.userApiKey&&(f={...f,userApiKey:E})}catch{}const g=async()=>await fetch(d,{method:"POST",headers:c,body:JSON.stringify(f)});let u=await g();try{console.log("[DesAInR][bg] API_CALL",{path:e.path,base:i,hasAuth:!!c.Authorization})}catch{}if(u.status===401){const o=await m(1e4,{openIfMissing:!0,promptLoginIfUnauthorized:!0});o!=null&&o.ok&&o.idToken&&(await p(o.idToken),c.Authorization=`Bearer ${o.idToken}`,u=await g())}let w,T;try{w=await u.json()}catch{try{T=await u.text()}catch{}}try{console.log("[DesAInR][bg] API_CALL response",{status:u.status,hasJson:!!w,hasText:!!T})}catch{}if(!u.ok&&(!w||typeof w!="object")){t({ok:!1,status:u.status,error:T||"HTTP error"});return}t({ok:u.ok,status:u.status,json:w??{}})}catch(i){t({ok:!1,status:0,error:(i==null?void 0:i.message)||String(i)})}})(),!0});
