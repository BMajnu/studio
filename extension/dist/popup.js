import{A}from"./chunks/config-Y9mzPb9C.js";let h=null,v=0;async function L(){return await new Promise(t=>{var e;try{(e=chrome.storage)==null||e.local.get(["DESAINR_BASE_URL"],s=>{t(s&&s.DESAINR_BASE_URL||null)})}catch{t(null)}})}async function S(t){var e;try{await((e=chrome.storage)==null?void 0:e.local.set({DESAINR_BASE_URL:t}))}catch{}}async function T(t){try{const e=await fetch(`${t}/api/extension/rewrite`,{method:"OPTIONS",headers:{"Content-Type":"application/json"}});return e.ok||e.status===204}catch{return!1}}async function k(){const t=Date.now();if(h&&t-v<6e4)return h;const e=[],s=await L();s&&e.push(s),e.push(A);const n=[...e,"http://localhost:9010","http://127.0.0.1:9010","http://localhost:9003","http://127.0.0.1:9003","http://localhost:3000","http://127.0.0.1:3000","http://localhost:5173","http://127.0.0.1:5173","http://localhost:8080","http://127.0.0.1:8080"],c=new Set;for(const o of n)if(!(!o||c.has(o))&&(c.add(o),await T(o)))return h=o,v=t,await S(o),o;return h=e[0]||"http://localhost:9010",v=t,h}async function _(t){return new Promise(e=>{chrome.tabs.query({active:!0,currentWindow:!0},async s=>{const n=s[0];if(!(n!=null&&n.id))return e(!1);const c=n.id,o=()=>new Promise(d=>{try{chrome.tabs.sendMessage(c,t,()=>{var E;const y=(E=chrome.runtime.lastError)==null?void 0:E.message;d(!y)})}catch{d(!1)}});let i=await o();if(i)return e(!0);try{await chrome.scripting.executeScript({target:{tabId:c},files:["contentScript.js"]})}catch(d){return console.warn("[DesAInR][popup] scripting injection failed:",d),e(!1)}i=await o(),e(i)})})}function f(t){const e=document.getElementById("error");e&&(e.textContent=t,e.style.display="block",setTimeout(()=>{e.style.display="none"},5e3))}function b(t){const e=document.getElementById("loading"),s=document.getElementById("signin-section"),n=document.getElementById("signout-section");e&&(e.style.display="block"),s&&(s.style.display="none"),n&&(n.style.display="none")}function w(){const t=document.getElementById("user-name"),e=document.getElementById("user-email"),s=document.getElementById("user-avatar"),n=document.getElementById("user-session");t&&(t.textContent=""),e&&(e.textContent=""),s&&(s.src="",s.style.display="none"),n&&(n.textContent="")}function C(t){const e=document.getElementById("user-name"),s=document.getElementById("user-email"),n=document.getElementById("user-avatar"),c=document.getElementById("user-session");e&&(e.textContent=(t==null?void 0:t.name)||(t==null?void 0:t.email)||"Signed account"),s&&(s.textContent=(t==null?void 0:t.email)||""),n&&(t!=null&&t.picture?(n.src=t.picture,n.style.display=""):(n.src="",n.style.display="none")),c&&(c.textContent=t!=null&&t.expired?"Expired":"Active")}async function R(){try{chrome.runtime.sendMessage({type:"AUTH_GET_PROFILE"},t=>{var s;if((s=chrome.runtime.lastError)==null?void 0:s.message){w();return}if(t!=null&&t.ok&&t.profile){C(t.profile);const n=document.getElementById("status-text");n&&(n.textContent=t.profile.expired?"Signed in (expired)":"Signed in")}else{w();const n=document.getElementById("status-text");n&&(n.textContent="Not signed in")}})}catch{w()}}function u(t){const e=document.getElementById("status-dot"),s=document.getElementById("status-text"),n=document.getElementById("loading"),c=document.getElementById("signin-section"),o=document.getElementById("signout-section");n&&(n.style.display="none"),e&&e.classList.add("active"),s&&(s.textContent=t?"Signed in":"Not signed in"),c&&(c.style.display=t?"none":"block"),o&&(o.style.display=t?"block":"none"),t?R():w()}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("open-overlay"),e=document.getElementById("open-webapp"),s=document.getElementById("open-designer"),n=document.getElementById("toggle-settings"),c=document.getElementById("settings-panel"),o=document.getElementById("setting-target-lang"),i=document.getElementById("setting-model-id"),d=document.getElementById("setting-thinking-mode"),y=document.getElementById("setting-user-api-key"),E=document.getElementById("save-settings"),B=document.getElementById("close-settings"),I=document.getElementById("signin"),p=document.getElementById("signout");(async()=>{try{u(!1),chrome.runtime.sendMessage({type:"AUTH_HAS_TOKEN"},a=>{var g;if((g=chrome.runtime.lastError)==null?void 0:g.message){u(!1);return}const r=!!(a&&a.hasToken);u(r)})}catch{u(!1)}})(),t==null||t.addEventListener("click",async()=>{if(!await _({type:"TOGGLE_OVERLAY"})){f("This page does not allow the overlay or the content script is blocked. Try a regular website tab.");return}window.close()}),e==null||e.addEventListener("click",async()=>{try{const a=await k();await chrome.tabs.create({url:`${a}/`}),window.close()}catch(a){f((a==null?void 0:a.message)||"Failed to open web app")}}),s==null||s.addEventListener("click",async()=>{try{const a=await k();await chrome.tabs.create({url:`${a}/designer`}),window.close()}catch(a){f((a==null?void 0:a.message)||"Failed to open designer page")}}),n==null||n.addEventListener("click",async()=>{if(!c)return;const a=c.style.display!=="none";if(c.style.display=a?"none":"block",!a)try{const m=await chrome.storage.local.get(["desainr.settings.targetLang","desainr.settings.modelId","desainr.settings.thinkingMode","desainr.settings.userApiKey"]);if(o&&(o.value=m["desainr.settings.targetLang"]||o.value||"en"),i){const r=m["desainr.settings.modelId"],g=i.options,l=r&&g&&Array.from(g).some(x=>x.value===r);i.value=l?r:i.value||"googleai/gemini-1.5-flash-latest"}if(d){const r=m["desainr.settings.thinkingMode"];d.value=r==="default"||r==="none"?r:d.value||"none"}y&&(y.value=m["desainr.settings.userApiKey"]||"")}catch{}}),E==null||E.addEventListener("click",async()=>{try{const a=((o==null?void 0:o.value)||"").trim(),m=((i==null?void 0:i.value)||"").trim(),r=((d==null?void 0:d.value)||"").trim(),g=((y==null?void 0:y.value)||"").trim();await chrome.storage.local.set({"desainr.settings.targetLang":a,"desainr.settings.modelId":m,"desainr.settings.thinkingMode":r||"none","desainr.settings.userApiKey":g}),f("");const l=document.getElementById("error");l&&(l.style.display="block",l.style.background="#c6f6d5",l.style.color="#22543d",l.textContent="Settings saved",setTimeout(()=>{l.style.display="none",l.style.background="",l.style.color=""},900))}catch(a){f((a==null?void 0:a.message)||"Failed to save settings")}}),B==null||B.addEventListener("click",()=>{c&&(c.style.display="none")}),I==null||I.addEventListener("click",async()=>{b();try{chrome.runtime.sendMessage({type:"AUTH_REQUEST_TOKEN"},async a=>{if(a&&a.ok){u(!0),window.close();return}try{const m=await k();await chrome.tabs.create({url:`${m}/login?next=/`})}catch{}u(!1)})}catch{u(!1)}}),p==null||p.addEventListener("click",async()=>{try{chrome.runtime.sendMessage({type:"AUTH_CLEAR_TOKEN"},()=>{u(!1)})}catch{u(!1)}})});
