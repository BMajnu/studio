import{o as C,A as v,s as $,f as R,a as N}from"./chunks/auth-oyTCJP_F.js";let f=null,B=0;async function D(){return await new Promise(n=>{var e;try{(e=chrome.storage)==null||e.local.get(["DESAINR_BASE_URL"],o=>{n(o&&o.DESAINR_BASE_URL||null)})}catch{n(null)}})}async function F(n){var e;try{await((e=chrome.storage)==null?void 0:e.local.set({DESAINR_BASE_URL:n}))}catch{}}async function j(n){try{const e=await fetch(`${n}/api/extension/rewrite`,{method:"OPTIONS",headers:{"Content-Type":"application/json"}});return e.ok||e.status===204}catch{return!1}}async function A(){const n=Date.now();if(f&&n-B<6e4)return f;const e=[],o=await D();o&&e.push(o),e.push(v);const s=[...e,"http://localhost:9010","http://127.0.0.1:9010","http://localhost:9003","http://127.0.0.1:9003","http://localhost:3000","http://127.0.0.1:3000","http://localhost:5173","http://127.0.0.1:5173","http://localhost:8080","http://127.0.0.1:8080"],i=new Set;for(const a of s)if(!(!a||i.has(a))&&(i.add(a),await j(a)))return f=a,B=n,await F(a),a;return f=e[0]||"http://localhost:9010",B=n,f}async function M(n){return new Promise(e=>{chrome.tabs.query({active:!0,currentWindow:!0},async o=>{const s=o[0];if(!(s!=null&&s.id))return e(!1);const i=()=>new Promise(r=>{try{chrome.tabs.sendMessage(s.id,n,()=>{var u;const d=(u=chrome.runtime.lastError)==null?void 0:u.message;r(!d)})}catch{r(!1)}});let a=await i();if(a)return e(!0);try{await chrome.scripting.executeScript({target:{tabId:s.id},files:["contentScript.js"]})}catch(r){return console.warn("[DesAInR][popup] scripting injection failed:",r),e(!1)}a=await i(),e(a)})})}function O(n){var a;const o=((a=new URL(n).hash)==null?void 0:a.replace(/^#/,""))||"",s=new URLSearchParams(o),i={};return s.forEach((r,d)=>i[d]=r),i}async function G(n){const e=await A(),o=await fetch(`${e}/api/extension/auth/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:n})}),s=await o.json().catch(()=>null);if(!o.ok){const i=s&&(s.error||s.message)||`Exchange failed: ${o.status}`;throw new Error(i)}return s}function m(n){const e=document.getElementById("error");e&&(e.textContent=n,e.style.display="block",setTimeout(()=>{e.style.display="none"},5e3))}function y(n){const e=document.getElementById("loading"),o=document.getElementById("signin-section"),s=document.getElementById("signout-section");e&&(e.style.display=n?"block":"none"),n&&(o&&(o.style.display="none"),s&&(s.style.display="none"))}function w(n){const e=document.getElementById("signin-section"),o=document.getElementById("signout-section"),s=document.getElementById("status-dot"),i=document.getElementById("status-text"),a=document.getElementById("loading");a&&(a.style.display="none"),n?(e&&(e.style.display="none"),o&&(o.style.display="block"),s&&s.classList.add("active"),i&&(i.textContent=`Signed in as ${n.email||"User"}`)):(e&&(e.style.display="block"),o&&(o.style.display="none"),s&&s.classList.remove("active"),i&&(i.textContent="Not signed in"))}document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("signin"),e=document.getElementById("signout"),o=document.getElementById("open-overlay"),s=document.getElementById("open-webapp"),i=document.getElementById("open-designer"),a=document.getElementById("toggle-settings"),r=document.getElementById("settings-panel"),d=document.getElementById("setting-target-lang"),u=document.getElementById("setting-model-id"),h=document.getElementById("setting-thinking-mode"),E=document.getElementById("save-settings"),k=document.getElementById("close-settings");C(R,t=>{w(t)}),o==null||o.addEventListener("click",async()=>{if(!await M({type:"TOGGLE_OVERLAY"})){m("This page does not allow the overlay or the content script is blocked. Try a regular website tab.");return}window.close()}),s==null||s.addEventListener("click",async()=>{try{await chrome.tabs.create({url:`${v}/`}),window.close()}catch(t){m((t==null?void 0:t.message)||"Failed to open web app")}}),i==null||i.addEventListener("click",async()=>{try{await chrome.tabs.create({url:`${v}/designer`}),window.close()}catch(t){m((t==null?void 0:t.message)||"Failed to open designer page")}}),a==null||a.addEventListener("click",async()=>{if(!r)return;const t=r.style.display!=="none";if(r.style.display=t?"none":"block",!t)try{const g=await chrome.storage.local.get(["desainr.settings.targetLang","desainr.settings.modelId","desainr.settings.thinkingMode"]);if(d&&(d.value=g["desainr.settings.targetLang"]||d.value||"en"),u){const l=g["desainr.settings.modelId"],c=l&&Array.from(u.options).some(p=>p.value===l);u.value=c?l:u.value||"googleai/gemini-1.5-flash-latest"}if(h){const l=g["desainr.settings.thinkingMode"];h.value=l==="default"||l==="none"?l:h.value||"none"}}catch{}}),E==null||E.addEventListener("click",async()=>{try{const t=((d==null?void 0:d.value)||"").trim(),g=((u==null?void 0:u.value)||"").trim(),l=((h==null?void 0:h.value)||"").trim();await chrome.storage.local.set({"desainr.settings.targetLang":t,"desainr.settings.modelId":g,"desainr.settings.thinkingMode":l||"none"}),m("");const c=document.getElementById("error");c&&(c.style.display="block",c.style.background="#c6f6d5",c.style.color="#22543d",c.textContent="Settings saved",setTimeout(()=>{c.style.display="none",c.style.background="",c.style.color=""},900))}catch(t){m((t==null?void 0:t.message)||"Failed to save settings")}}),k==null||k.addEventListener("click",()=>{r&&(r.style.display="none")}),n==null||n.addEventListener("click",async()=>{try{y(!0),m("");const t=chrome.identity.getRedirectURL("extension_cb");console.log("Redirect URL:",t);const g=await A();let l=g;try{const I=new URL(g);I.hostname==="localhost"&&(I.hostname="127.0.0.1"),l=I.toString().replace(/\/$/,"")}catch{}const c=`${l}/extension/connect?redirect_uri=${encodeURIComponent(t)}`;console.log("Auth URL:",c);const p=await chrome.identity.launchWebAuthFlow({url:c,interactive:!0});if(!p)throw new Error("Authentication was cancelled");const L=O(p),S=L.id_token;if(!S)throw console.error("No id_token in response:",L),new Error("No authentication token received");const{ok:b,customToken:x,uid:T,error:P}=await G(S);if(!b)throw new Error(P||"Failed to exchange token");const U=await $(R,x),_=await U.user.getIdToken(!0);await chrome.storage.local.set({"desainr.auth.uid":T,"desainr.auth.idToken":_,"desainr.auth.signedInAt":Date.now()}),w(U.user),y(!1)}catch(t){console.error("Popup sign-in error:",t),y(!1),w(null),m((t==null?void 0:t.message)||"Sign-in failed. Please try again.")}}),e==null||e.addEventListener("click",async()=>{try{y(!0),await N(),w(null),y(!1)}catch(t){console.error("Popup sign-out error:",t),y(!1),m((t==null?void 0:t.message)||"Sign-out failed")}})});
