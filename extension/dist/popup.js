import{o as B,A as I,s as A,f as b,a as x}from"./chunks/auth-CJvrIxYh.js";const L="modulepreload",_=function(s){return"/"+s},v={},P=function(t,e,a){let l=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),r=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));l=Promise.allSettled(e.map(c=>{if(c=_(c),c in v)return;v[c]=!0;const d=c.endsWith(".css"),g=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${g}`))return;const u=document.createElement("link");if(u.rel=d?"stylesheet":L,d||(u.as="script"),u.crossOrigin="",u.href=c,r&&u.setAttribute("nonce",r),document.head.appendChild(u),d)return new Promise((n,h)=>{u.addEventListener("load",n),u.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(i){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=i,window.dispatchEvent(r),!r.defaultPrevented)throw i}return l.then(i=>{for(const r of i||[])r.status==="rejected"&&o(r.reason);return t().catch(o)})};let p=null,w=0;async function D(s=8e3,t){const e=await S(),a=async()=>await new Promise(i=>{const r=e.endsWith("/")?`${e}*`:`${e}/*`;chrome.tabs.query({url:r},c=>{i(c&&c[0]?c[0]:null)})}),o=await(async()=>{const i=await a();return i&&i.id?i:null})();return o!=null&&o.id?await new Promise(i=>{let r=!1;const c=g=>{r||(r=!0,i(g))},d=()=>new Promise(g=>{try{chrome.tabs.sendMessage(o.id,{type:"DESAINR_GET_WEBAPP_ID_TOKEN"},u=>{var h;if((h=chrome.runtime.lastError)==null?void 0:h.message)return g(!1);c(u||{ok:!1,error:"no_response"})})}catch{g(!1)}});(async()=>{let g=await d();if(!r){if(!g){try{await chrome.scripting.executeScript({target:{tabId:o.id},files:["contentScript.js"]})}catch{}if(g=await d(),r)return}setTimeout(()=>{c({ok:!1,error:"timeout"})},s)}})()}):{ok:!1,error:"no_webapp_tab"}}async function R(s){try{const e=await D(8e3,{openIfMissing:!1});if(!(e!=null&&e.ok)||!e.idToken){const u=(e==null?void 0:e.error)||"unknown";return}const a=e.idToken,{ok:l,customToken:o,uid:i,error:r,diagnostics:c}=await N(a);if(c)try{console.info("[DesAInR][ext][exchange] diagnostics "+JSON.stringify(c))}catch{}if(!l)throw new Error(r||"Failed to exchange token");let d;try{d=await x(b,o)}catch(u){console.error("Direct sign-in error:",u);try{const{FIREBASE_WEB_CONFIG:n}=await P(async()=>{const{FIREBASE_WEB_CONFIG:y}=await import("./chunks/auth-CJvrIxYh.js").then(m=>m.c);return{FIREBASE_WEB_CONFIG:y}},[]),h=n==null?void 0:n.apiKey;if(h){const y=await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signInWithCustomToken?key=${h}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:o,returnSecureToken:!0})}),m=await y.json().catch(()=>null);try{console.warn("[DesAInR][ext][signIn][rest] http "+y.status)}catch{}try{console.warn("[DesAInR][ext][signIn][rest] body "+JSON.stringify(m))}catch{}}}catch{}throw u}const g=await d.user.getIdToken(!0);await chrome.storage.local.set({"desainr.auth.uid":i,"desainr.auth.idToken":g,"desainr.auth.signedInAt":Date.now()}),k(d.user)}catch(e){console.error("Direct sign-in error:",e);{try{console.warn("[DesAInR][popup] Auto sign-in (silent) failed:",(e==null?void 0:e.message)||e)}catch{}return}}}async function C(){return await new Promise(s=>{var t;try{(t=chrome.storage)==null||t.local.get(["DESAINR_BASE_URL"],e=>{s(e&&e.DESAINR_BASE_URL||null)})}catch{s(null)}})}async function O(s){var t;try{await((t=chrome.storage)==null?void 0:t.local.set({DESAINR_BASE_URL:s}))}catch{}}async function U(s){try{const t=await fetch(`${s}/api/extension/rewrite`,{method:"OPTIONS",headers:{"Content-Type":"application/json"}});return t.ok||t.status===204}catch{return!1}}async function S(){const s=Date.now();if(p&&s-w<6e4)return p;const t=[],e=await C();e&&t.push(e),t.push(I);const a=[...t,"http://localhost:9010","http://127.0.0.1:9010","http://localhost:9003","http://127.0.0.1:9003","http://localhost:3000","http://127.0.0.1:3000","http://localhost:5173","http://127.0.0.1:5173","http://localhost:8080","http://127.0.0.1:8080"],l=new Set;for(const o of a)if(!(!o||l.has(o))&&(l.add(o),await U(o)))return p=o,w=s,await O(o),o;return p=t[0]||"http://localhost:9010",w=s,p}async function $(s){return new Promise(t=>{chrome.tabs.query({active:!0,currentWindow:!0},async e=>{const a=e[0];if(!(a!=null&&a.id))return t(!1);const l=a.id,o=()=>new Promise(r=>{try{chrome.tabs.sendMessage(l,s,()=>{var d;const c=(d=chrome.runtime.lastError)==null?void 0:d.message;r(!c)})}catch{r(!1)}});let i=await o();if(i)return t(!0);try{await chrome.scripting.executeScript({target:{tabId:l},files:["contentScript.js"]})}catch(r){return console.warn("[DesAInR][popup] scripting injection failed:",r),t(!1)}i=await o(),t(i)})})}async function N(s){const t=await S(),e=await fetch(`${t}/api/extension/auth/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:s})}),a=await e.json().catch(()=>null);try{console.info("[DesAInR][ext][exchange] http "+e.status)}catch{}try{console.info("[DesAInR][ext][exchange] body "+JSON.stringify(a))}catch{}if(!e.ok){const l=a&&(a.error||a.message)||`Exchange failed: ${e.status}`,o=a&&(a.diagnostics||null)||null;if(o)try{console.warn("[DesAInR][ext][exchange] diagnostics "+JSON.stringify(o))}catch{}throw new Error(l)}return a}function f(s){const t=document.getElementById("error");t&&(t.textContent=s,t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3))}function E(s){const t=document.getElementById("loading"),e=document.getElementById("signin-section"),a=document.getElementById("signout-section");t&&(t.style.display=s?"block":"none"),s&&(e&&(e.style.display="none"),a&&(a.style.display="none"))}function k(s){const t=document.getElementById("signin-section"),e=document.getElementById("signout-section"),a=document.getElementById("status-dot"),l=document.getElementById("status-text"),o=document.getElementById("loading");o&&(o.style.display="none"),s?(t&&(t.style.display="none"),e&&(e.style.display="block"),a&&a.classList.add("active"),l&&(l.textContent=`Signed in as ${s.email||"User"}`)):(t&&(t.style.display="block"),e&&(e.style.display="none"),a&&a.classList.remove("active"),l&&(l.textContent="Not signed in"))}document.addEventListener("DOMContentLoaded",()=>{const s=document.getElementById("signin"),t=document.getElementById("signout"),e=document.getElementById("open-overlay"),a=document.getElementById("open-webapp"),l=document.getElementById("open-designer"),o=document.getElementById("toggle-settings"),i=document.getElementById("settings-panel"),r=document.getElementById("setting-target-lang"),c=document.getElementById("setting-model-id"),d=document.getElementById("setting-thinking-mode"),g=document.getElementById("save-settings"),u=document.getElementById("close-settings");B(b,n=>{k(n),n||setTimeout(()=>{try{R({silent:!0})}catch{}},300)}),e==null||e.addEventListener("click",async()=>{if(!await $({type:"TOGGLE_OVERLAY"})){f("This page does not allow the overlay or the content script is blocked. Try a regular website tab.");return}window.close()}),a==null||a.addEventListener("click",async()=>{try{await chrome.tabs.create({url:`${I}/`}),window.close()}catch(n){f((n==null?void 0:n.message)||"Failed to open web app")}}),l==null||l.addEventListener("click",async()=>{try{await chrome.tabs.create({url:`${I}/designer`}),window.close()}catch(n){f((n==null?void 0:n.message)||"Failed to open designer page")}}),o==null||o.addEventListener("click",async()=>{if(!i)return;const n=i.style.display!=="none";if(i.style.display=n?"none":"block",!n)try{const h=await chrome.storage.local.get(["desainr.settings.targetLang","desainr.settings.modelId","desainr.settings.thinkingMode"]);if(r&&(r.value=h["desainr.settings.targetLang"]||r.value||"en"),c){const y=h["desainr.settings.modelId"],m=y&&Array.from(c.options).some(T=>T.value===y);c.value=m?y:c.value||"googleai/gemini-1.5-flash-latest"}if(d){const y=h["desainr.settings.thinkingMode"];d.value=y==="default"||y==="none"?y:d.value||"none"}}catch{}}),g==null||g.addEventListener("click",async()=>{try{const n=((r==null?void 0:r.value)||"").trim(),h=((c==null?void 0:c.value)||"").trim(),y=((d==null?void 0:d.value)||"").trim();await chrome.storage.local.set({"desainr.settings.targetLang":n,"desainr.settings.modelId":h,"desainr.settings.thinkingMode":y||"none"}),f("");const m=document.getElementById("error");m&&(m.style.display="block",m.style.background="#c6f6d5",m.style.color="#22543d",m.textContent="Settings saved",setTimeout(()=>{m.style.display="none",m.style.background="",m.style.color=""},900))}catch(n){f((n==null?void 0:n.message)||"Failed to save settings")}}),u==null||u.addEventListener("click",()=>{i&&(i.style.display="none")}),s==null||s.addEventListener("click",async()=>{try{const n=await S();await chrome.tabs.create({url:`${n}/login`}),window.close()}catch(n){f((n==null?void 0:n.message)||"Failed to open login page")}}),t==null||t.addEventListener("click",async()=>{try{E(!0),await A(),k(null),E(!1)}catch(n){console.error("Popup sign-out error:",n),E(!1),f((n==null?void 0:n.message)||"Sign-out failed")}})});
