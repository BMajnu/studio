import{o as g,s as m,f as c,a as p}from"./chunks/auth-DCUILQwn.js";import{APP_BASE_URL as d}from"./chunks/config-3JFiQANb.js";function y(t){var a;const e=((a=new URL(t).hash)==null?void 0:a.replace(/^#/,""))||"",i=new URLSearchParams(e),o={};return i.forEach((r,s)=>o[s]=r),o}async function w(t){const n=await fetch(`${d}/api/extension/auth/exchange`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({idToken:t})});if(!n.ok)throw new Error(`Exchange failed: ${n.status}`);return n.json()}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("signin"),n=document.getElementById("signout");g(c,e=>{e?(t&&(t.style.display="none"),n&&(n.style.display="inline-block")):(t&&(t.style.display="inline-block"),n&&(n.style.display="none"))}),t==null||t.addEventListener("click",async()=>{try{const e=chrome.identity.getRedirectURL("extension_cb"),i=`${d}/extension/connect?redirect_uri=${encodeURIComponent(e)}`,o=await chrome.identity.launchWebAuthFlow({url:i,interactive:!0});if(!o)throw new Error("No final URL from WebAuthFlow");const r=y(o).id_token;if(!r)throw new Error("No id_token returned");const{ok:s,customToken:u,uid:l,error:h}=await w(r);if(!s)throw new Error(h||"Exchange returned not ok");const f=await(await m(c,u)).user.getIdToken(!0);await chrome.storage.local.set({"desainr.auth.uid":l,"desainr.auth.idToken":f,"desainr.auth.signedInAt":Date.now()}),alert("Signed in successfully. You can close this popup.")}catch(e){console.error("Popup sign-in error:",e),alert(`Sign-in failed: ${(e==null?void 0:e.message)||e}`)}}),n==null||n.addEventListener("click",async()=>{try{await p(),alert("Signed out.")}catch(e){console.error("Popup sign-out error:",e),alert(`Sign-out failed: ${(e==null?void 0:e.message)||e}`)}})});
