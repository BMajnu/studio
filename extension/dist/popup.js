import{A as v}from"./chunks/config-CwCn-sz8.js";let k=null,L=0;async function T(e){var t;try{await((t=chrome.storage)==null?void 0:t.local.set({DESAINR_BASE_URL:e}))}catch{}}async function x(){const e=Date.now();return k&&e-L<6e4?k:(k=v,L=e,await T(v),v)}async function p(e){return new Promise(t=>{chrome.tabs.query({active:!0,currentWindow:!0},async a=>{const n=a[0];if(!(n!=null&&n.id))return t(!1);const o=n.id,c=()=>new Promise(d=>{try{chrome.tabs.sendMessage(o,e,()=>{var E;const g=(E=chrome.runtime.lastError)==null?void 0:E.message;d(!g)})}catch{d(!1)}});let i=await c();if(i)return t(!0);try{await chrome.scripting.executeScript({target:{tabId:o},files:["contentScript.js"]})}catch(d){return console.warn("[DesAInR][popup] scripting injection failed:",d),t(!1)}i=await c(),t(i)})})}function f(e){const t=document.getElementById("error");t&&(t.textContent=e,t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3))}function b(e){const t=document.getElementById("loading"),a=document.getElementById("signin-section"),n=document.getElementById("signout-section");t&&(t.style.display="block"),a&&(a.style.display="none"),n&&(n.style.display="none")}function h(){const e=document.getElementById("user-name"),t=document.getElementById("user-email"),a=document.getElementById("user-avatar"),n=document.getElementById("user-session");e&&(e.textContent=""),t&&(t.textContent=""),a&&(a.src="",a.style.display="none"),n&&(n.textContent="")}function C(e){const t=document.getElementById("user-name"),a=document.getElementById("user-email"),n=document.getElementById("user-avatar"),o=document.getElementById("user-session");t&&(t.textContent=(e==null?void 0:e.name)||(e==null?void 0:e.email)||"Signed account"),a&&(a.textContent=(e==null?void 0:e.email)||""),n&&(e!=null&&e.picture?(n.src=e.picture,n.style.display=""):(n.src="",n.style.display="none")),o&&(o.textContent=e!=null&&e.expired?"Expired":"Active")}async function S(){try{chrome.runtime.sendMessage({type:"AUTH_GET_PROFILE"},e=>{var a;if((a=chrome.runtime.lastError)==null?void 0:a.message){h();return}if(e!=null&&e.ok&&e.profile){C(e.profile);const n=document.getElementById("status-text");n&&(n.textContent=e.profile.expired?"Signed in (expired)":"Signed in")}else{h();const n=document.getElementById("status-text");n&&(n.textContent="Not signed in")}})}catch{h()}}function u(e){const t=document.getElementById("status-dot"),a=document.getElementById("status-text"),n=document.getElementById("loading"),o=document.getElementById("signin-section"),c=document.getElementById("signout-section");n&&(n.style.display="none"),t&&t.classList.add("active"),a&&(a.textContent=e?"Signed in":"Not signed in"),o&&(o.style.display=e?"none":"block"),c&&(c.style.display=e?"block":"none"),e?S():h()}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("open-overlay"),t=document.getElementById("open-webapp"),a=document.getElementById("open-designer"),n=document.getElementById("toggle-settings"),o=document.getElementById("settings-panel"),c=document.getElementById("setting-target-lang"),i=document.getElementById("setting-model-id"),d=document.getElementById("setting-thinking-mode"),g=document.getElementById("setting-user-api-key"),E=document.getElementById("save-settings"),B=document.getElementById("close-settings"),I=document.getElementById("signin"),w=document.getElementById("signout");(async()=>{try{u(!1),chrome.runtime.sendMessage({type:"AUTH_HAS_TOKEN"},s=>{var y;if((y=chrome.runtime.lastError)==null?void 0:y.message){u(!1);return}const r=!!(s&&s.hasToken);u(r)})}catch{u(!1)}})(),e==null||e.addEventListener("click",async()=>{if(!await p({type:"TOGGLE_OVERLAY"})){f("This page does not allow the overlay or the content script is blocked. Try a regular website tab.");return}window.close()}),t==null||t.addEventListener("click",async()=>{try{const s=await x();await chrome.tabs.create({url:`${s}/`}),window.close()}catch(s){f((s==null?void 0:s.message)||"Failed to open web app")}}),a==null||a.addEventListener("click",async()=>{try{const s=await x();await chrome.tabs.create({url:`${s}/designer`}),window.close()}catch(s){f((s==null?void 0:s.message)||"Failed to open designer page")}}),n==null||n.addEventListener("click",async()=>{if(!o)return;const s=o.style.display!=="none";if(o.style.display=s?"none":"block",!s)try{const m=await chrome.storage.local.get(["desainr.settings.targetLang","desainr.settings.modelId","desainr.settings.thinkingMode","desainr.settings.userApiKey"]);if(c&&(c.value=m["desainr.settings.targetLang"]||c.value||"en"),i){const r=m["desainr.settings.modelId"],y=i.options,l=r&&y&&Array.from(y).some(A=>A.value===r);i.value=l?r:i.value||"googleai/gemini-1.5-flash-latest"}if(d){const r=m["desainr.settings.thinkingMode"];d.value=r==="default"||r==="none"?r:d.value||"none"}g&&(g.value=m["desainr.settings.userApiKey"]||"")}catch{}}),E==null||E.addEventListener("click",async()=>{try{const s=((c==null?void 0:c.value)||"").trim(),m=((i==null?void 0:i.value)||"").trim(),r=((d==null?void 0:d.value)||"").trim(),y=((g==null?void 0:g.value)||"").trim();await chrome.storage.local.set({"desainr.settings.targetLang":s,"desainr.settings.modelId":m,"desainr.settings.thinkingMode":r||"none","desainr.settings.userApiKey":y}),f("");const l=document.getElementById("error");l&&(l.style.display="block",l.style.background="#c6f6d5",l.style.color="#22543d",l.textContent="Settings saved",setTimeout(()=>{l.style.display="none",l.style.background="",l.style.color=""},900))}catch(s){f((s==null?void 0:s.message)||"Failed to save settings")}}),B==null||B.addEventListener("click",()=>{o&&(o.style.display="none")}),I==null||I.addEventListener("click",async()=>{b();try{chrome.runtime.sendMessage({type:"AUTH_REQUEST_TOKEN"},async s=>{if(s&&s.ok){u(!0),window.close();return}try{const m=await x();await chrome.tabs.create({url:`${m}/login?next=/`})}catch{}u(!1)})}catch{u(!1)}}),w==null||w.addEventListener("click",async()=>{try{chrome.runtime.sendMessage({type:"AUTH_CLEAR_TOKEN"},()=>{u(!1)})}catch{u(!1)}})});
